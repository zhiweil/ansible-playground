# Reuse playbook by including
Ansible playbooks and tasks can be included into another playbook. Including is a "dynamic" way of reusing playbooks. 

You can think of "dynamic" as running a sub-processes. The temlates and variables are applied at runtime.  

## Before you begin
The environment of running the Ansible playbook is setup by the following steps. 
```bash
# go to the project root folder if you are not here
cd ansible-learning

# destroy existing docker images which might contain results of previous running of playbooks
docker-compose down

# spinning up new docker images for this test
docker-compose up

# logging into the anisble master docker image
docker exec -it ansible-master bash

# inside ansible master docker image, go to the folder of this lab
cd /root/playground/playbook-import

# test connections with both managed nodes
# SSH to node1
ssh ansible-node1
# exit the ssh sesseion and come back to master node
exit
# SSH to node2
ssh ansible-node2
# exit the ssh sesseion and come back to master node
exit
```

## Directory structure
The directory tree of folder /root/playground/playbook-import looks like this:
```text
|-- README.md
|-- host_vars
|   |-- ansible-node1.yml
|   `-- ansible-node2.yml
|-- inventory
|-- plays
|   |-- configure-apache.yml
|   |-- host_vars
|   |   |-- ansible-node1.yml
|   |   `-- ansible-node2.yml
|   |-- install-apache.yml
|   `-- templates
|       |-- 000-default.conf.j2
|       |-- index.html.j2
|       `-- ports.conf.j2
|-- templates
|   |-- 000-default.conf.j2
|   |-- index.html.j2
|   `-- ports.conf.j2
`-- website.yml
```
* The file "website.yml" is the ansible playbook used in this lab.
* The file "inventory" is the inventory of ansible playbook used in this lab.
* The folder "host_vars" contains variables for each managed node.
* The folder "templates" contains the templates used in this lab.
* The folder "plays" contains the child playbooks.
  * children variables in folder plays/host_vars
  * children templates in folder plays/templates

## Run playbook
Under the foler /root/playground/playbook-import, run ansible playbook:
```bash
ansible-playbook -i inventory  website.yml
```

## Browse websites
The websites can be accessed via "curl" inside master node by 
```bash
curl ansible-node1:8080
```

If every goes well, this will be displayed:
```html
<!DOCTYPE html>
<html>
  <body>
    <h1> Welcode to Ansible node 1 - outter - generated by child template!
  </body>
</html>
```
If both parent and children define templates and variables:
* The parent variables are applied as they are closer to the playbook!
* The children templates are applied as they closer to the children playbooks.
* If child templates are removed. The parent ones will be applied. 
```bash
rm -r /root/playground/playbook-include/templates

# run playbook again and reload homepage
ansible-playbook -i inventory  website.yml
curl ansible-node1:8080
```

The children templates and variables are applied.
```html
<!DOCTYPE html>
<html>
  <body>
    <h1> Welcode to Ansible node 1 - outter - generated by parent template!
  </body>
</html>
```

**NOTE: you cannot remove the parent variables**