# Reuse playbook by importing
Ansible playbooks and tasks can be imported to another playbook. Importing is at "static" way of reusing playbooks. 

You can think of "static" as copying a child playbook into its parent when parsing the parent playbook, so it becomes part of parent playbook at run time. 
As a result, the variables and templates apply to its children. 

## Before you begin
The environment of running the Ansible playbook is setup by the following steps. 
```bash
# go to the project root folder if you are not here
cd ansible-learning

# destroy existing docker images which might contain results of previous running of playbooks
docker-compose down

# spinning up new docker images for this test
docker-compose up

# logging into the anisble master docker image
docker exec -it ansible-master bash

# inside ansible master docker image, go to the folder of this lab
cd /root/playground/playbook-import

# test connections with both managed nodes
# SSH to node1
ssh ansible-node1
# exit the ssh sesseion and come back to master node
exit
# SSH to node2
ssh ansible-node2
# exit the ssh sesseion and come back to master node
exit
```

## Directory structure
The directory tree of folder /root/playground/playbook-import looks like this:
```text
|-- README.md
|-- host_vars
|   |-- ansible-node1.yml
|   `-- ansible-node2.yml
|-- inventory
|-- plays
|   |-- configure-apache.yml
|   `-- install-apache.yml
|-- templates
|   |-- 000-default.conf.j2
|   |-- index.html.j2
|   `-- ports.conf.j2
`-- website.yml
```
* The file "website.yml" is the ansible playbook used in this lab.
* The file "inventory" is the inventory of ansible playbook used in this lab.
* The folder "host_vars" contains variables for each managed node.
* The folder "templates" contains the templates used in this lab.
* The foler "plays" contains the child playbooks.

## Playbook
Now the playbook becomes very simple:
```yml
---
- hosts: webservers
  remote_user: root

  tasks:
    - include_tasks: ./plays/install-apache.yml
    - include_tasks: ./plays/configure-apache.yml

  handlers:
    - name: restart apache2
      service: name=apache2 state=restarted
```

## Run playbook
Under the foler /root/playground/playbook-import, run ansible playbook:
```bash
ansible-playbook -i inventory  website.yml
```

## Browse websites
The websites can be accessed via "curl" inside master node by 
```bash
curl ansible-node1:8080
```

If every goes well, this will be displayed:
```html
<!DOCTYPE html>
<html>
  <body>
    <h1> Welcode to Ansible node 1
  </body>
</html>
```
The parent's variables and templates are applied to child playbooks.

# How static reuse works?
To give you an idea on how import reuses playbooks statically, please run the following test while you are inside ansible control node.
```bash
# inside ansible master docker image, go to the folder of this lab
cd /root/playground/playbook-import

# move templates and host_vars to the "plays" directory.
mv templates/ plays/
mv host_vars/ plays/

# run playbook again
ansible-playbook -i inventory website.yml
```

The following errors would happen.
```text
fatal: [ansible-node1]: FAILED! => {"changed": false, "msg": "AnsibleUndefinedVariable: 'ansible_node' is undefined"}
fatal: [ansible-node2]: FAILED! => {"changed": false, "msg": "AnsibleUndefinedVariable: 'ansible_node' is undefined"}
```

Two things are worth noting:
* The templates can be put into either parent and children levels.
* The static importing ALWAYS applies the parent level variables.

What would happen if the same templates are found at both parent and children level? The following test will answer this question. 
```bash
# move the host_vars back to parent level
mv plays/host_vars/ .

# replicate the templates folder so that it exists at both parent and chidren levels
cp -r plays/templates/ .
```

Change the parent level template of website home page.
```html
<!DOCTYPE html>
<html>
  <body>
    <h1> Welcode to {{ansible_node}} - generated by parent template!
  </body>
</html>
```

Run playbook again and then access the home page of managed node #1. 
```bash
# run playbook again
ansible-playbook -i inventory website.yml
curl ansible-node1:8080
```

You'll the parent home page template is applied.
```text
<!DOCTYPE html>
<html>
  <body>
    <h1> Welcode to Ansible node 1 - generated by parent template!
  </body>
</html>
```

**NOTE: you cannot remove the parent variables**